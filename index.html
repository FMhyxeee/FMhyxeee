<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>hyx_blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="hyx_blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="hyx_blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="hyx">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="hyx_blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">hyx_blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-LearnTinyHttp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/05/LearnTinyHttp/" class="article-date">
  <time datetime="2020-10-04T16:00:00.000Z" itemprop="datePublished">2020-10-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/05/LearnTinyHttp/">国庆假期特别篇-TinyHttp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="LearnTinyHttp"><a href="#LearnTinyHttp" class="headerlink" title="LearnTinyHttp"></a>LearnTinyHttp</h3><hr>
<p>TinyHttp 是 <strong>J. David’s webserver</strong> 实现的一个500行的微型服务器。通过这个微型服务器，可以对线程、http等等有一定的认识和理解，同时对服务器如何运行进行学习。</p>
<p><strong>OverView：</strong></p>
<ul>
<li><p>main() -&gt; startup() -&gt; accept_request() -&gt;[ execute_cgi() or serve_file()]</p>
<img src="/2020/10/05/LearnTinyHttp/overview.jpg" class="">
</li>
<li><p><strong>main：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">      <span class="keyword">int</span> server_sock = <span class="number">-1</span>;</span><br><span class="line">      u_short port = <span class="number">4000</span>;<span class="comment">//指定端口为 4000 </span></span><br><span class="line">      <span class="keyword">int</span> client_sock = <span class="number">-1</span>;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_name</span>;</span></span><br><span class="line">      <span class="keyword">socklen_t</span> client_name_len = <span class="keyword">sizeof</span>(client_name);</span><br><span class="line">      <span class="keyword">pthread_t</span> newthread;</span><br><span class="line">  </span><br><span class="line">      server_sock = startup(&amp;port);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"httpd running on port %d \n"</span>,port);</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Waiting for a connect!\n"</span>);</span><br><span class="line">          client_sock = accept(server_sock,</span><br><span class="line">                  (struct sockaddr* )&amp;client_name,</span><br><span class="line">                          &amp;client_name_len);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Deal connect on %d\n"</span>,client_sock);</span><br><span class="line">          <span class="keyword">if</span> (client_sock == <span class="number">-1</span>)&#123;</span><br><span class="line">              error_die(<span class="string">"accept"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (pthread_create(&amp;newthread , <span class="literal">NULL</span>, accept_request, &amp;client_sock) != <span class="number">0</span>)&#123;</span><br><span class="line">              perror(<span class="string">"pthread_create"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">close</span>(server_sock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p>  ​    startup建立server_sock，然后等待client_sock连接，连接后，启动一个新的线程进行任务逻辑的处理。</p>
<ul>
<li><p><strong>startup:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startup</span><span class="params">(u_short *port)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> httpd = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">name</span>;</span></span><br><span class="line"></span><br><span class="line">    httpd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (httpd == <span class="number">-1</span>)&#123;</span><br><span class="line">        error_die(<span class="string">"socket"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;name,<span class="number">0</span>,<span class="keyword">sizeof</span>(name));</span><br><span class="line">    name.sin_family = AF_INET;</span><br><span class="line">    <span class="comment">//这里这个大端小端还是没搞明白，是规定的还是？</span></span><br><span class="line">    name.sin_port = htons(*port);</span><br><span class="line">    name.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    <span class="keyword">if</span> (bind(httpd,(struct sockaddr*) &amp;name,<span class="keyword">sizeof</span>(name)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        error_die(<span class="string">"bind"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*port == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">socklen_t</span>  namelen = <span class="keyword">sizeof</span>(name);</span><br><span class="line">        <span class="keyword">if</span> (getsockname(httpd,(struct sockaddr*)&amp;name,&amp;namelen) == <span class="number">-1</span>)&#123;</span><br><span class="line">            error_die(<span class="string">"getsockname"</span>);</span><br><span class="line">            *port = ntohs(name.sin_port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">listen</span>(httpd,<span class="number">5</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        error_die(<span class="string">"listen"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> httpd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>socket()函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>domain</td>
<td>设置通信域(本地(PF_LOCAL),ipv4(AF_INET),ipv6()等)</td>
</tr>
<tr>
<td>type</td>
<td>设置套接字通信类型(TCP,双向字节流(SOCK_STREAM),UDP(SOCK_DGRAM))</td>
</tr>
<tr>
<td>protocol</td>
<td>某个协议的特定类型,既type类型中某个类型.通常只有一个类型,所以设置成0</td>
</tr>
</tbody></table>
<p>struct sockaddr_in：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> &#123;</span></span><br><span class="line">　　short <span class="keyword">int</span> sin_family; <span class="comment">/*指代协议族，在socket编程中只能是AF_INET */</span></span><br><span class="line">　　<span class="keyword">unsigned</span> short <span class="keyword">int</span> sin_port; <span class="comment">/* 端口号 */</span></span><br><span class="line">　　<span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span> <span class="comment">/* IP地址, in_addr这个数据结构,下面会有对in_addr的介绍*/</span></span><br><span class="line">　　<span class="keyword">unsigned</span> <span class="keyword">char</span> sin_zero[<span class="number">8</span>]; <span class="comment">/* Same size as struct sockaddr */</span></span><br><span class="line">　　&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> &#123;</span></span><br><span class="line">　　<span class="keyword">union</span> &#123;</span><br><span class="line">　　<span class="class"><span class="keyword">struct</span>&#123;</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> s_b1,s_b2, s_b3,s_b4;&#125; S_un_b;</span><br><span class="line">　　<span class="class"><span class="keyword">struct</span>&#123;</span> <span class="keyword">unsigned</span> short s_w1, s_w2;&#125; S_un_w;</span><br><span class="line">　　<span class="keyword">unsigned</span> <span class="keyword">long</span> S_addr;</span><br><span class="line">　　&#125; S_un;</span><br><span class="line">　　&#125; IN_ADDR;</span><br></pre></td></tr></table></figure>

<p>socklen_t</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在<span class="number">32</span>位下<span class="keyword">size_t</span>和<span class="keyword">int</span>长度相同,都是<span class="number">32b</span>it,</span><br><span class="line">在<span class="number">64</span>位下<span class="keyword">size_t</span>和<span class="keyword">int</span>长度不同,分别是<span class="number">32b</span>it和<span class="number">64b</span>it</span><br><span class="line">而socket中accpet函数的第三个参数必须和<span class="keyword">int</span>长度相同,所以变设置了<span class="keyword">socklen_t</span>的类型</span><br></pre></td></tr></table></figure>

<p>accept()</p>
<p>​    提取所监听套接字的第一个链接请求,创建新的套接字,并返回文件描述符,新建立的套接字准备发送send()和接收数据recv()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd,struct sockaddr *addr,<span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>sockfd</td>
<td>经过绑定(bind),监听(listen)的socket套接字描述符</td>
</tr>
<tr>
<td>addr</td>
<td>客户端的地址结构体</td>
</tr>
<tr>
<td>addrlen</td>
<td>sizeof(struct sockaddr_in),客户端地址结构体的大小</td>
</tr>
</tbody></table>
<p>本地和网络字节转换</p>
<p>​    网络字节顺序NBO（Network Byte Order）,按从高到底顺序存储,(大端：低位存放在高字节)<br>主机字节顺序（HBO，Host Byte Order）（小端：低位存放在低字节）</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>htonl()</td>
<td>“Host to Network Long int”</td>
</tr>
<tr>
<td>ntohl()</td>
<td>“Network to Host Long int”</td>
</tr>
<tr>
<td>htons()</td>
<td>“Host to Network Short int”</td>
</tr>
<tr>
<td>ntohs()</td>
<td>“Network to Host Short int”</td>
</tr>
</tbody></table>
<p>bind()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct sockaddr *addr,<span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br></pre></td></tr></table></figure>

<p>​    当用socket()函数创建套接字以后，套接字在名称空间(网络地址族)中存在，但没有任何地址给它赋值。bind()把用<strong><em>addr</em></strong>指定的地址赋值给用文件描述符代表的套接字<strong><em>sockfd</em></strong>。<strong><em>addrlen</em></strong>指定了以<strong><em>addr</em></strong>所指向的地址结构体的字节长度。一般来说，该操作称为“给套接字命名”。</p>
<p>bind()函数并不是总是需要调用的，只有用户进程想与一个具体的地址或端口相关联的时候才需要调用这个函数。如果用户进程没有这个需要，那么程序可以依赖内核的自动的选址机制来完成自动地址选择，而不需要调用bind()函数，同时也避免不必要的复杂度。在一般情况下，对于服务器进程问题需要调用bind()函数，对于客户进程则不需要调用bind()函数。</p>
<p>listen()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> backlog)</span></span>;</span><br></pre></td></tr></table></figure>

<p>​    listen函数使用主动连接套接字，使得一个进程可以接受其它进程的请求，从而成为一个服务器进程。在TCP服务器编程中listen函数把进程变为一个服务器，并指定相应的套接字变为被动连接。</p>
<p>​    listen函数一般在调用bind之后-调用accept之前调用。</p>
<p>​    <strong>sockfd</strong> 一个已绑定未被连接的套接字描述符</p>
<p>​    <strong>backlog</strong> 连接请求队列(queue of pending connections)的最大长度（一般由2到4）。用SOMAXCONN则由系统确定。</p>
<p>accept()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd,struct sockaddr *addr,<span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br></pre></td></tr></table></figure>

<p>accept()系统调用主要用在基于连接的套接字类型，比如SOCK_STREAM和SOCK_SEQPACKET。它<strong>提取出所监听套接字的等待连接队列中第一个连接请求</strong>，<strong>创建一个新的套接字，并返回指向该套接字的文件描述符</strong>。新建立的套接字不在监听状态，原来所监听的套接字也不受该系统调用的影响。</p>
<p>pthread_create()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(<span class="keyword">pthread_t</span> *tidp,<span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *attr,<span class="keyword">void</span> *(*start_rtn)(<span class="keyword">void</span>*),<span class="keyword">void</span> *arg)</span></span>;</span><br></pre></td></tr></table></figure>

<p>​    编译时，需要加上 -lpthread 参数</p>
<p>​    返回成功时，由tidp指向的内存单元被设置为新创建线程的线程ID。attr参数用于指定各种不同的线程属性。新创建的线程从start_rtn函数的地址开始运行，该函数只有一个万能指针参数arg，如果需要向start_rtn函数传递的参数不止一个，那么需要把这些参数放到一个结构中，然后把这个结构的地址作为arg的参数传入。</p>
</li>
<li><p>accept_request()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">accept_request</span><span class="params">(<span class="keyword">void</span>* arg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> client = *(<span class="keyword">int</span>*) arg; <span class="comment">//拿到sock_client</span></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">size_t</span> numchars;</span><br><span class="line">    <span class="keyword">char</span> method[<span class="number">255</span>];</span><br><span class="line">    <span class="keyword">char</span> url[<span class="number">255</span>];</span><br><span class="line">    <span class="keyword">char</span> path[<span class="number">512</span>];</span><br><span class="line">    <span class="keyword">size_t</span> i, j;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">int</span> cgi = <span class="number">0</span>; <span class="comment">//如果是cgi的话，则变为1</span></span><br><span class="line">    <span class="keyword">char</span> *query_string = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//拿到http的第一条信息</span></span><br><span class="line">    numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    i = <span class="number">0</span>; j = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//把buf里面的内容放到method里面</span></span><br><span class="line">    <span class="keyword">while</span> (!ISpaces(buf[i]) &amp;&amp; (i &lt; <span class="keyword">sizeof</span>(method)<span class="number">-1</span>))&#123;</span><br><span class="line">        method[i] = buf[i];</span><br><span class="line">        i++; j++;</span><br><span class="line">    &#125;</span><br><span class="line">    method[i] = <span class="string">'\0'</span>; <span class="comment">//给method补一个截至符</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method,<span class="string">"GET"</span>) &amp;&amp; strcasecmp(method,<span class="string">"POST"</span>))&#123;</span><br><span class="line">        unimplemented(client);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method,<span class="string">"POST"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        cgi = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (ISpaces(buf[j]) &amp;&amp; (j &lt; numchars))&#123;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (!ISpaces(buf[j]) &amp;&amp; (i &lt; <span class="keyword">sizeof</span>(url) - <span class="number">1</span>) &amp;&amp; (j &lt; <span class="keyword">sizeof</span>(buf)))&#123;</span><br><span class="line">        url[i] = buf[j];</span><br><span class="line">        i++; j++;</span><br><span class="line">    &#125;</span><br><span class="line">    url[i] = <span class="string">'\0'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method,<span class="string">"GET"</span>)== <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"GET! and URL is %s\n"</span>,url);</span><br><span class="line">        query_string = url;</span><br><span class="line">        <span class="keyword">while</span> ((*query_string != <span class="string">'?'</span>) &amp;&amp; (*query_string != <span class="string">'\0'</span>))&#123;</span><br><span class="line">            query_string++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (*query_string == <span class="string">'?'</span>)&#123;</span><br><span class="line">            cgi = <span class="number">1</span>;</span><br><span class="line">            *query_string = <span class="string">'\0'</span>;</span><br><span class="line">            query_string++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//把../htdocs/xxx写入path内</span></span><br><span class="line">    <span class="built_in">sprintf</span>(path,<span class="string">"../htdocs%s"</span>,url);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果直接使用ip地址访问的话，会返回xxx.xxx.xxx.xxx/index.html</span></span><br><span class="line">    <span class="keyword">if</span> (path[<span class="built_in">strlen</span>(path)<span class="number">-1</span>] == <span class="string">'/'</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(path,<span class="string">"index.html"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断path目录的资源是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (stat(path,&amp;st) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>,buf))&#123;</span><br><span class="line">            numchars = get_line(client,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">        not_found(client);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((st.st_mode &amp; S_IFMT) == S_IFDIR)&#123;</span><br><span class="line">            <span class="built_in">strcat</span>(path, <span class="string">"/index.html"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((st.st_mode &amp; S_IXUSR) ||  (st.st_mode &amp; S_IXGRP) || (st.st_mode &amp; S_IXOTH))&#123;</span><br><span class="line">            cgi = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!cgi)&#123;</span><br><span class="line">            serve_file(client, path);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            execute_cgi(client,path,method,query_string);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(client);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>stat()</p>
<p>如果资源路径，相对路径或者绝对路径存在的话，返回0，同时将资源的信息放在指定的struct stat buf内</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">buf</span>;</span></span><br><span class="line">stat(<span class="string">""</span>/etc/passwd<span class="string">",&amp;buf);</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">    <span class="keyword">dev_t</span> st_dev; <span class="comment">//device 文件的设备编号</span></span><br><span class="line">    <span class="keyword">ino_t</span> st_ino; <span class="comment">//inode 文件的i-node</span></span><br><span class="line">    <span class="keyword">mode_t</span> st_mode; <span class="comment">//protection 文件的类型和存取的权限</span></span><br><span class="line">    <span class="keyword">nlink_t</span> st_nlink; <span class="comment">//number of hard links 连到该文件的硬连接数目, 刚建立的文件值为1.</span></span><br><span class="line">    <span class="keyword">uid_t</span> st_uid; <span class="comment">//user ID of owner 文件所有者的用户识别码</span></span><br><span class="line">    <span class="keyword">gid_t</span> st_gid; <span class="comment">//group ID of owner 文件所有者的组识别码</span></span><br><span class="line">    <span class="keyword">dev_t</span> st_rdev; <span class="comment">//device type 若此文件为装置设备文件, 则为其设备编号</span></span><br><span class="line">    <span class="keyword">off_t</span> st_size; <span class="comment">//total size, in bytes 文件大小, 以字节计算</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> st_blksize; <span class="comment">//blocksize for filesystem I/O 文件系统的I/O 缓冲区大小.</span></span><br><span class="line">    u nsigned <span class="keyword">long</span> st_blocks; <span class="comment">//number of blocks allocated 占用文件区块的个数, 每一区块大小为512 个字节.</span></span><br><span class="line">    <span class="keyword">time_t</span> st_atime; <span class="comment">//time of lastaccess 文件最近一次被存取或被执行的时间, 一般只有在用mknod、 utime、read、write 与tructate 时改变.</span></span><br><span class="line">    <span class="keyword">time_t</span> st_mtime; <span class="comment">//time of last modification 文件最后一次被修改的时间, 一般只有在用mknod、 utime 和write 时才会改变</span></span><br><span class="line">    <span class="keyword">time_t</span> st_ctime; <span class="comment">//time of last change i-node 最近一次被更改的时间, 此参数会在文件所有者、组、 权限被更改时更新</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>再根据资源的drwx属性给定cgi值，同时决定调用的是 serve_file() 或者 execute_cgi() 方法</p>
</li>
<li><p>serve_file(int client, const char* filename)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serve_file</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span>&#123;</span><br><span class="line">    FILE *resource = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> numchars = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="string">'A'</span>; buf[<span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf))&#123;</span><br><span class="line">        numchars = get_line(client,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    &#125;</span><br><span class="line">    resource = fopen(filename,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (resource == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        not_found(client);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        headers(client,filename);</span><br><span class="line">        cat(client, resource);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向client中写入resource内容</p>
</li>
<li><p>headers()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">headers</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span>* filename)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    (<span class="keyword">void</span>)filename; <span class="comment">//使用文件名称来推测文件类型</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, <span class="string">"HTTP/1.0 200 OK\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, SERVER_STRING);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"Content-Type: text/html\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, <span class="string">"\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>cat()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cat</span><span class="params">(<span class="keyword">int</span> client, FILE *resource)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    fgets(buf, <span class="keyword">sizeof</span>(buf), resource);</span><br><span class="line">    <span class="keyword">while</span> (!feof(resource))&#123;</span><br><span class="line">        send(client,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">        fgets(buf,<span class="keyword">sizeof</span>(buf),resource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">fgets</span><span class="params">(<span class="keyword">char</span>* s, <span class="keyword">int</span> <span class="built_in">size</span>, FILE* stream)</span></span>;</span><br></pre></td></tr></table></figure>

<p>fgets函数，每次从file* 中读取size个字节放入s中，虽然麻烦一点，但是每次读取之后不会产生数组越界等等问题。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">send</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len, <span class="keyword">int</span> flags)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>execute_cgi()</p>
<p>cgi 执行脚本的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execute_cgi</span><span class="params">(<span class="keyword">int</span> client, <span class="keyword">const</span> <span class="keyword">char</span> *path,<span class="keyword">const</span> <span class="keyword">char</span> *method, <span class="keyword">const</span> <span class="keyword">char</span> *query_string)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> cgi_output[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> cgi_input[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">int</span> numchars = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> content_length = <span class="number">-1</span>;</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="string">'A'</span>; buf[<span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(method,<span class="string">"GET"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>, buf))&#123;</span><br><span class="line">            numchars = get_line(client,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(method,<span class="string">"POST"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">        numchars = get_line(client, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="keyword">while</span> ((numchars &gt; <span class="number">0</span>) &amp;&amp; <span class="built_in">strcmp</span>(<span class="string">"\n"</span>,buf))&#123;</span><br><span class="line">            buf[<span class="number">15</span>] = <span class="string">'\n'</span>;</span><br><span class="line">            <span class="keyword">if</span> (strcasecmp(buf,<span class="string">"Content-Length:"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                content_length = atoi(&amp;buf[<span class="number">16</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            numchars = get_line(client,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (content_length == <span class="number">-1</span>)&#123;</span><br><span class="line">            bad_request(client);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">"HTTP/1.0 200 OK\r\n"</span>);</span><br><span class="line">    send(client, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(cgi_output) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(cgi_input) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        cannot_execute(client);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">sprintf</span>(buf,<span class="string">"HTTP/1.0 200 OK\r\n"</span>);</span><br><span class="line">    send(client,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)&#123;  <span class="comment">//启动子线程处理cgi</span></span><br><span class="line">        <span class="keyword">char</span> meth_env[<span class="number">255</span>];</span><br><span class="line">        <span class="keyword">char</span> query_env[<span class="number">255</span>];</span><br><span class="line">        <span class="keyword">char</span> lenght_env[<span class="number">255</span>];</span><br><span class="line"></span><br><span class="line">        dup2(cgi_output[<span class="number">1</span>], STDOUT);</span><br><span class="line">        dup2(cgi_input[<span class="number">0</span>], STDIN);</span><br><span class="line">        <span class="built_in">close</span>(cgi_output[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">close</span>(cgi_input[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sprintf</span>(meth_env, <span class="string">"REQUEST_METHOD=%s"</span>,method);</span><br><span class="line">        putenv(meth_env);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(method,<span class="string">"GET"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(query_string,<span class="string">"QUERY_STRING=%s"</span>,query_string);</span><br><span class="line">            putenv(query_string);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">//POST</span></span><br><span class="line">            <span class="built_in">sprintf</span>(lenght_env,<span class="string">"CONTENT_LENGTH=%s"</span>,content_length);</span><br><span class="line">            putenv(lenght_env);</span><br><span class="line">        &#125;</span><br><span class="line">        execl(path,path,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">//父线程处理逻辑</span></span><br><span class="line">        <span class="built_in">close</span>(cgi_output[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">close</span>(cgi_input[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(method,<span class="string">"POST"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; content_length; ++i) &#123;</span><br><span class="line">                recv(client,&amp;c,<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="built_in">write</span>(cgi_input[<span class="number">1</span>],&amp;c,<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">read</span>(cgi_output[<span class="number">0</span>],&amp;c,<span class="number">1</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            send(client,&amp;c,<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(cgi_output[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">close</span>(cgi_input[<span class="number">1</span>]);</span><br><span class="line">        waitpid(pid,&amp;status,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>atoi()</p>
<p>将字符串转换成数字</p>
<p>itoa()</p>
<p>将整型数字转换为字符串</p>
<p>dup2()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dup2</span><span class="params">(<span class="keyword">int</span> oldfd,<span class="keyword">int</span> newfd)</span></span></span><br></pre></td></tr></table></figure>

<p>​    dup2复制旧的文件描述符oldfd，新的文件描述符和旧的文件描述符指向“打开文件描述表”的相同入口，所以他们拥有相同的offset和status。但新文件描述符和旧文件描述符的flags不相同。close-on-exec这个标记在新文件描述符上被关闭。dup2使用参数newfd作为新的文件描述符。</p>
<p>putenv()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">putenv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* <span class="built_in">string</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>​    putenv()用来改变或增加环境变量的内容. 参数string 的格式为name＝value, 如果该环境变量原先存在, 则变量内容会依参数string 改变, 否则此参数内容会成为新的环境变量。</p>
<p>execl()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execl</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * path, <span class="keyword">const</span> <span class="keyword">char</span> * arg, ...)</span></span>;</span><br></pre></td></tr></table></figure>

<p>execl()用来执行参数path 字符串所代表的文件路径, 接下来的参数代表执行该文件时传递过去的argv(0), argv[1], …, 最后一个参数必须用空指针(NULL)作结束.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">  execl(<span class="string">"/bin/ls"</span>, <span class="string">"ls"</span>, <span class="string">"-al"</span>, <span class="string">"/etc/passwd"</span>, (<span class="keyword">char</span> *)<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fork()</p>
<p>fork()函数会返回3中情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">//处理创建错误逻辑</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">//处理子线程逻辑</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">//处理父线程逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个函数中，使用pipe进行父子线程通信。将子线程处理好的内容传给父线程，最后输出给客户端的sock_client </p>
<p>waitpid()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">waitpid</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span>* status, <span class="keyword">int</span> options)</span></span>;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>源码可以从 <a href="http://tinyhttpd.sourceforge.net/" target="_blank" rel="noopener">http://tinyhttpd.sourceforge.net/</a> 进行下载阅读</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/10/05/LearnTinyHttp/" data-id="ckfwobq2n00058srdfy2v1w7a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C-HTTP/" rel="tag">C HTTP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sqlclient2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/05/sqlclient2/" class="article-date">
  <time datetime="2020-08-05T12:16:05.000Z" itemprop="datePublished">2020-08-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/05/sqlclient2/">sqlclient2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Flink-SqlClient2"><a href="#Flink-SqlClient2" class="headerlink" title="Flink SqlClient2"></a>Flink SqlClient2</h3><ul>
<li><h4 id="localExecutor-解读"><a href="#localExecutor-解读" class="headerlink" title="localExecutor 解读"></a>localExecutor 解读</h4><p> localExecutor是sqlclient中直接与flink环境进行交互的类，包含了所有flink支持的DDL和DML类型操作的实现方法。</p>
<p>localExecutor只能在flink集群内启动，调用flink内部classloader</p>
<ul>
<li><p>Executor接口解读</p>
<p> 官方注释 : A gateway for communicating with Flink and other external systems.  </p>
<img src="/2020/08/05/sqlclient2/ExecutorStructor.png" class="">

<p>通过实现这些接口方法，可以做到对于表的增删改，和对表内数据的增删改查</p>
</li>
<li><p>LocalExecutor实现类</p>
<p>localExecutor是调用本地的flink cluster，同时在Executor中持有多个不同session窗口，</p>
<p>使用一个 ConcurrentHaspMap持有所有的session identifer</p>
<p>同时持有如下的句柄：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//deployment</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ClusterClientServiceLoader clusterClientServiceLoader;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Environment defaultEnvironment;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> List&lt;URL&gt; dependencies;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Configuration flinkConfig;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> List&lt;CustomCommandLine&gt; commandLines;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Options commandLineOptions;</span><br><span class="line">   <span class="comment">//result maintenance</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ResultStore resultStore;</span><br></pre></td></tr></table></figure>

<p>在localExecutor中，实现了sqlclient中的基本方法：</p>
<img src="/2020/08/05/sqlclient2/help.png" class="">

<p>同时还有最重要的 executeQuery方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultDescriptor <span class="title">executeQuery</span><span class="params">(String sessionId, String query)</span> <span class="keyword">throws</span> SqlExecutionException </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> ExecutionContext&lt;?&gt; context = getExecutionContext(sessionId);</span><br><span class="line">	<span class="keyword">return</span> executeQueryInternal(sessionId, context, query);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 ExecutionContext的注解为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Context for executing table programs. This class caches everything that can be cached across</span><br><span class="line">multiple queries as long as the session context does not change. This must be thread-safe as</span><br><span class="line">it might be reused across different query submissions.</span><br></pre></td></tr></table></figure>

<p>这个类为执行上下文，保存了一个ClusterID中的所有内容。</p>
<p>首先看看Execution中的Builder私有类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Required members.</span></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> SessionContext sessionContext;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> List&lt;URL&gt; dependencies;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Configuration configuration;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> ClusterClientServiceLoader serviceLoader;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Options commandLineOptions;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> List&lt;CustomCommandLine&gt; commandLines;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> Environment defaultEnv;</span><br><span class="line">		<span class="keyword">private</span> Environment currentEnv;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Optional members.</span></span><br><span class="line">		<span class="meta">@Nullable</span></span><br><span class="line">		<span class="keyword">private</span> SessionState sessionState;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">				Environment defaultEnv,</span></span></span><br><span class="line"><span class="function"><span class="params">				@Nullable SessionContext sessionContext,</span></span></span><br><span class="line"><span class="function"><span class="params">				List&lt;URL&gt; dependencies,</span></span></span><br><span class="line"><span class="function"><span class="params">				Configuration configuration,</span></span></span><br><span class="line"><span class="function"><span class="params">				ClusterClientServiceLoader serviceLoader,</span></span></span><br><span class="line"><span class="function"><span class="params">				Options commandLineOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">				List&lt;CustomCommandLine&gt; commandLines)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.defaultEnv = defaultEnv;</span><br><span class="line">	<span class="keyword">this</span>.sessionContext = sessionContext;</span><br><span class="line">			<span class="keyword">this</span>.dependencies = dependencies;</span><br><span class="line">	<span class="keyword">this</span>.configuration = configuration;</span><br><span class="line">			<span class="keyword">this</span>.serviceLoader = serviceLoader;</span><br><span class="line">	<span class="keyword">this</span>.commandLineOptions = commandLineOptions;</span><br><span class="line">			<span class="keyword">this</span>.commandLines = commandLines;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Builder <span class="title">env</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.currentEnv = environment;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Builder <span class="title">sessionState</span><span class="params">(SessionState sessionState)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.sessionState = sessionState;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> ExecutionContext&lt;?&gt; build() &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> ExecutionContext&lt;&gt;(</span><br><span class="line">						<span class="keyword">this</span>.currentEnv == <span class="keyword">null</span></span><br><span class="line">								? Environment.merge(defaultEnv, sessionContext.getSessionEnv())</span><br><span class="line">								: <span class="keyword">this</span>.currentEnv,</span><br><span class="line">						<span class="keyword">this</span>.sessionContext,</span><br><span class="line">						<span class="keyword">this</span>.sessionState,</span><br><span class="line">						<span class="keyword">this</span>.dependencies,</span><br><span class="line">						<span class="keyword">this</span>.configuration,</span><br><span class="line">						<span class="keyword">this</span>.serviceLoader,</span><br><span class="line">						<span class="keyword">this</span>.commandLineOptions,</span><br><span class="line">						<span class="keyword">this</span>.commandLines);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">				<span class="comment">// catch everything such that a configuration does not crash the executor</span></span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> SqlExecutionException(<span class="string">"Could not create execution context."</span>, t);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>由这个类来生成ExecutionContext，其中builder需要的参数为：Environment、SessionContext、依赖jar包的List<URL>,配置文件Configuration，集群Server的ClassLoader，指令参数，指令列表。 由此返回一个ExecutionContext对象。</p>
<p>在ExecutionContext的构造方法中，首先拿到了父类加载器classLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">classloader = FlinkUserCodeClassLoaders.parentFirst(</span><br><span class="line">	dependencies.toArray(<span class="keyword">new</span> URL[dependencies.size()]),</span><br><span class="line">    <span class="keyword">this</span>.getClass.getClassLoader();</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>之后初始化TableEnviroment</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeTableEnvironment</span><span class="params">(@Nullable SessionState sessionState)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> EnvironmentSettings settings = environment.getExecution().getEnvironmentSettings();</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">boolean</span> noInheritedState = sessionState == <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (noInheritedState) &#123;</span><br><span class="line">			<span class="comment">//--------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// Step.1 Create environments</span></span><br><span class="line">			<span class="comment">//--------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// Step 1.0 Initialize the table configuration.</span></span><br><span class="line">			<span class="keyword">final</span> TableConfig config = <span class="keyword">new</span> TableConfig();</span><br><span class="line">			environment.getConfiguration().asMap().forEach((k, v) -&gt;</span><br><span class="line">					config.getConfiguration().setString(k, v));</span><br><span class="line">			<span class="comment">// Step 1.1 Initialize the CatalogManager if required.</span></span><br><span class="line">			<span class="keyword">final</span> CatalogManager catalogManager = <span class="keyword">new</span> CatalogManager(</span><br><span class="line">					settings.getBuiltInCatalogName(),</span><br><span class="line">					<span class="keyword">new</span> GenericInMemoryCatalog(</span><br><span class="line">							settings.getBuiltInCatalogName(),</span><br><span class="line">							settings.getBuiltInDatabaseName()));</span><br><span class="line">			<span class="comment">// Step 1.2 Initialize the ModuleManager if required.</span></span><br><span class="line">			<span class="keyword">final</span> ModuleManager moduleManager = <span class="keyword">new</span> ModuleManager();</span><br><span class="line">			<span class="comment">// Step 1.3 Initialize the FunctionCatalog if required.</span></span><br><span class="line">			<span class="keyword">final</span> FunctionCatalog functionCatalog = <span class="keyword">new</span> FunctionCatalog(config, catalogManager, moduleManager);</span><br><span class="line">			<span class="comment">// Step 1.4 Set up session state.</span></span><br><span class="line">			<span class="keyword">this</span>.sessionState = SessionState.of(config, catalogManager, moduleManager, functionCatalog);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Must initialize the table environment before actually the</span></span><br><span class="line">			createTableEnvironment(settings, config, catalogManager, moduleManager, functionCatalog);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//--------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// Step.2 Create modules and load them into the TableEnvironment.</span></span><br><span class="line">			<span class="comment">//--------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// No need to register the modules info if already inherit from the same session.</span></span><br><span class="line">			Map&lt;String, Module&gt; modules = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">			environment.getModules().forEach((name, entry) -&gt;</span><br><span class="line">					modules.put(name, createModule(entry.asMap(), classLoader))</span><br><span class="line">			);</span><br><span class="line">			<span class="keyword">if</span> (!modules.isEmpty()) &#123;</span><br><span class="line">				<span class="comment">// unload core module first to respect whatever users configure</span></span><br><span class="line">				tableEnv.unloadModule(CoreModuleDescriptorValidator.MODULE_TYPE_CORE);</span><br><span class="line">				modules.forEach(tableEnv::loadModule);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//--------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// Step.3 create user-defined functions and temporal tables then register them.</span></span><br><span class="line">			<span class="comment">//--------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// No need to register the functions if already inherit from the same session.</span></span><br><span class="line">			registerFunctions();</span><br><span class="line"></span><br><span class="line">			<span class="comment">//--------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// Step.4 Create catalogs and register them.</span></span><br><span class="line">			<span class="comment">//--------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">			<span class="comment">// No need to register the catalogs if already inherit from the same session.</span></span><br><span class="line">			initializeCatalogs();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Set up session state.</span></span><br><span class="line">			<span class="keyword">this</span>.sessionState = sessionState;</span><br><span class="line">			createTableEnvironment(</span><br><span class="line">					settings,</span><br><span class="line">					sessionState.config,</span><br><span class="line">					sessionState.catalogManager,</span><br><span class="line">					sessionState.moduleManager,</span><br><span class="line">					sessionState.functionCatalog);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>初始化一个 environment 其中：</p>
<ol>
<li>初始化TableConfig</li>
<li>如果有catalog，则初始化catalog</li>
<li>如果有module，则初始化module</li>
<li>初始化自定义function </li>
<li>建立一个session state</li>
</ol>
<p>初始化完成后，调用createTableEnvironment 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">createTableEnvironment(settings, config, catalogManager, moduleManager, functionCatalog);</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createTableEnvironment</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			EnvironmentSettings settings,</span></span></span><br><span class="line"><span class="function"><span class="params">			TableConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">			CatalogManager catalogManager,</span></span></span><br><span class="line"><span class="function"><span class="params">			ModuleManager moduleManager,</span></span></span><br><span class="line"><span class="function"><span class="params">			FunctionCatalog functionCatalog)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (environment.getExecution().isStreamingPlanner()) &#123;</span><br><span class="line">			streamExecEnv = createStreamExecutionEnvironment();</span><br><span class="line">			execEnv = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">final</span> Map&lt;String, String&gt; executorProperties = settings.toExecutorProperties();</span><br><span class="line">			executor = lookupExecutor(executorProperties, streamExecEnv);</span><br><span class="line">			tableEnv = createStreamTableEnvironment(</span><br><span class="line">					streamExecEnv,</span><br><span class="line">					settings,</span><br><span class="line">					config,</span><br><span class="line">					executor,</span><br><span class="line">					catalogManager,</span><br><span class="line">					moduleManager,</span><br><span class="line">					functionCatalog);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (environment.getExecution().isBatchPlanner()) &#123;</span><br><span class="line">			streamExecEnv = <span class="keyword">null</span>;</span><br><span class="line">			execEnv = createExecutionEnvironment();</span><br><span class="line">			executor = <span class="keyword">null</span>;</span><br><span class="line">			tableEnv = <span class="keyword">new</span> BatchTableEnvironmentImpl(</span><br><span class="line">					execEnv,</span><br><span class="line">					config,</span><br><span class="line">					catalogManager,</span><br><span class="line">					moduleManager);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SqlExecutionException(<span class="string">"Unsupported execution type specified."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法中，首先判断了这个sql是流还是批，如果是流模式的话，则调用createStreamExecutionEnvironment() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> StreamExecutionEnvironment <span class="title">createStreamExecutionEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">	env.setRestartStrategy(environment.getExecution().getRestartStrategy());</span><br><span class="line">	env.setParallelism(environment.getExecution().getParallelism());</span><br><span class="line">	env.setMaxParallelism(environment.getExecution().getMaxParallelism());</span><br><span class="line">	env.setStreamTimeCharacteristic(environment.getExecution().getTimeCharacteristic());</span><br><span class="line">	<span class="keyword">if</span> (env.getStreamTimeCharacteristic() == TimeCharacteristic.EventTime) &#123;</span><br><span class="line">		env.getConfig().setAutoWatermarkInterval(environment.getExecution().getPeriodicWatermarksInterval());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> env;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过调用 StreamExecutionEnvironment.getExecutionEnvironment() 方法，拿到StreamExecutionEnvironment 环境。</p>
<p>同时通过lookupExecutor()拿到executor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Executor <span class="title">lookupExecutor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		Map&lt;String, String&gt; executorProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">		StreamExecutionEnvironment executionEnvironment)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		ExecutorFactory executorFactory = ComponentFactoryService.find(ExecutorFactory<span class="class">.<span class="keyword">class</span>, <span class="title">executorProperties</span>)</span>;</span><br><span class="line">		Method createMethod = executorFactory.getClass()</span><br><span class="line">			.getMethod(<span class="string">"create"</span>, Map<span class="class">.<span class="keyword">class</span>, <span class="title">StreamExecutionEnvironment</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    </span><br><span class="line">		<span class="keyword">return</span> (Executor) createMethod.invoke(</span><br><span class="line">			executorFactory,</span><br><span class="line">			executorProperties,</span><br><span class="line">			executionEnvironment);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> TableException(</span><br><span class="line">			<span class="string">"Could not instantiate the executor. Make sure a planner module is on the classpath"</span>,</span><br><span class="line">			e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 module 并且 读入 TableEnironment：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Module&gt; modules = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">environment.getModules().forEach((name, entry) -&gt;</span><br><span class="line">		modules.put(name, createModule(entry.asMap(), classLoader))</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (!modules.isEmpty()) &#123;</span><br><span class="line">	<span class="comment">// unload core module first to respect whatever users configure</span></span><br><span class="line">	tableEnv.unloadModule(CoreModuleDescriptorValidator.MODULE_TYPE_CORE);</span><br><span class="line">	modules.forEach(tableEnv::loadModule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册function：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerFunctions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Map&lt;String, FunctionDefinition&gt; functions = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">	environment.getFunctions().forEach((name, entry) -&gt; &#123;</span><br><span class="line">		<span class="keyword">final</span> UserDefinedFunction function = FunctionService.createFunction(entry.getDescriptor(), classLoader, <span class="keyword">false</span>);</span><br><span class="line">		functions.put(name, function);</span><br><span class="line">	&#125;);</span><br><span class="line">	registerFunctions(functions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册视图 view:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">environment.getTables().forEach((name, entry) -&gt; &#123;</span><br><span class="line">			<span class="comment">// if registering a view fails at this point,</span></span><br><span class="line">			<span class="comment">// it means that it accesses tables that are not available anymore</span></span><br><span class="line">			<span class="keyword">if</span> (entry <span class="keyword">instanceof</span> ViewEntry) &#123;</span><br><span class="line">				<span class="keyword">final</span> ViewEntry viewEntry = (ViewEntry) entry;</span><br><span class="line">				registerView(viewEntry);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>

<p>设置catalog和database</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Switch to the current catalog.</span></span><br><span class="line">		Optional&lt;String&gt; catalog = environment.getExecution().getCurrentCatalog();</span><br><span class="line">		catalog.ifPresent(tableEnv::useCatalog);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Switch to the current database.</span></span><br><span class="line">		Optional&lt;String&gt; database = environment.getExecution().getCurrentDatabase();</span><br><span class="line">		database.ifPresent(tableEnv::useDatabase);</span><br></pre></td></tr></table></figure>

<p>这样就可以使用tableEnvironment进行sql编程了！</p>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/05/sqlclient2/" data-id="ckfwobq2t000d8srde6uy5fn6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flink/" rel="tag">flink</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-StarCraft-Java" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/12/StarCraft-Java/" class="article-date">
  <time datetime="2020-07-12T05:02:41.000Z" itemprop="datePublished">2020-07-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/12/StarCraft-Java/">StarCraft_Java</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>写这篇文章的时候，同时也是我正式工作第一年的纪念日，在工作的第一年里，慢慢熟悉了工作的流程，公司的规矩和一个重新认识自己的态度。如果给我第一年的工作成果打分的话，我愿意打75分给我自己，有了新的态度，但是同样的还是很懒散，如果要有所成就的话，需要对自己有一定的约束。</p>
<hr>
<h4 id="StarCraft"><a href="#StarCraft" class="headerlink" title="StarCraft"></a>StarCraft</h4><p>​    星际争霸是一个非常早，但是非常有趣的游戏，在我读大学时候，偶然翻到了某个牛人使用Java写的版本，一直很想彻彻底底的将整个游戏和设计思路过一边，希望对自己有所帮助。正好趁端午节休息的时候，将代码细细的看一遍。</p>
<h5 id="结构设置"><a href="#结构设置" class="headerlink" title="结构设置"></a>结构设置</h5><img src="/2020/07/12/StarCraft-Java/%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" class="">

<p>可以看到，StarCraft是一个纯Java项目，其中</p>
<ul>
<li>res 是资源路径。<ul>
<li>images 中会存放有各种单位的图像。</li>
<li>map 中则会存放有地图模型资源。</li>
</ul>
</li>
<li>screen 中则是启动游戏时候的初始页面图片。<ul>
<li><img src="/2020/07/12/StarCraft-Java/login.jpg" class=""></li>
</ul>
</li>
<li>src是源码目录，可以看到，一共分为8个模块：<ul>
<li>core：一些基础的操作类，选中类，地图绘制，图片绘制等等。</li>
<li>gui: 其中定义了游戏内的图像类的接口，并且在包内的ui包中实现了定义好的抽象接口，实现了不同的游戏窗口组件。</li>
<li>icon： 比较简单的定义了一个含有icon image图片的图标类，用于显示在ui菜单上，点击时候开始制造单位，例如点击之后制造机枪兵。</li>
<li>net： 网络通信包，其中包括udp扫描是否有创建好的房间，同时还有datagram传递消息，和socket保持通讯。</li>
<li>particle：血条类，被攻击后会有各种变化。</li>
<li>test：测试类，程序入口就在当中。</li>
<li>tile： 各种游戏单位的实例类，比如建筑，工人，机枪兵，坦克等等。</li>
<li>util：util中是各种工具，主要是编写了一个寻路工具。</li>
</ul>
</li>
</ul>
<hr>
<h6 id="util-类"><a href="#util-类" class="headerlink" title="util 类"></a>util 类</h6><p>​    我看代码的习惯是从Test开始开，如果没有test，就先看util方法，在向整个项目开始延申。</p>
<img src="/2020/07/12/StarCraft-Java/util.png" class="">

<p>​    可以看到，除了Resource之外，其他都是和寻路有关的类。</p>
<ul>
<li><p>Resource</p>
<p>资源类，里面有mine和man2个属性很好理解，是关于建造资源的POJO。</p>
</li>
<li><p>AStarNode</p>
<p>路线节点的最小单位，实现了Comparable接口，接口内方法比较</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Object other)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">float</span> thisValue = <span class="keyword">this</span>.getCost();</span><br><span class="line">	<span class="keyword">float</span> otherValue = ((AStarNode) other).getCost();</span><br><span class="line">	<span class="keyword">float</span> v = thisValue - otherValue;</span><br><span class="line">	<span class="keyword">return</span> (v &gt; <span class="number">0</span>) ? <span class="number">1</span> : (v &lt; <span class="number">0</span>) ? -<span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getCost</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> costFromStart + estimatedCostToGoal;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getCost</span><span class="params">(Object other)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> getEstimatedCost(node);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getEstimatedCost</span><span class="params">(AStarNode node)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">	AStarNode other = (AStarNode) node;</span><br><span class="line">	<span class="keyword">float</span> dx = location.x - other.location.x;</span><br><span class="line">	<span class="keyword">float</span> dz = location.y - other.location.y;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">float</span>) Math.sqrt(dx * dx + dz * dz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>AStarSearch</p>
<p>在这个类中，实现了一个继承自LinkedList的优先级队列，重写了add方法，使得添加进去的元素按照顺序排列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityList</span> <span class="keyword">extends</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Comparable object)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size(); i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (object.compareTo(get(i)) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">				add(i, object);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		addLast(object);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>  同时还实现了构造路径发方法，constructPath</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> LinkedList&lt;Point&gt; <span class="title">constructPath</span><span class="params">(AStarNode node)</span> </span>&#123;</span><br><span class="line">	LinkedList&lt;Point&gt; path = <span class="keyword">new</span> LinkedList&lt;Point&gt;();</span><br><span class="line">	<span class="keyword">while</span> (node.pathParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">		path.addFirst(node.location);</span><br><span class="line">		node = node.pathParent;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>  以及寻找攻击路线，findFightPath</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinkedList&lt;AStarNode&gt; <span class="title">findFightPath</span><span class="params">(GridMap map,Tile goal)</span></span>&#123;</span><br><span class="line">		AStarNode goalNode = <span class="keyword">new</span> AStarNode(<span class="keyword">new</span> Point(goal.getTileX(),goal.getTileY()));</span><br><span class="line">		Point size = goal.getSize();</span><br><span class="line">		</span><br><span class="line">		LinkedList&lt;AStarNode&gt; boundNodes = <span class="keyword">new</span> LinkedList&lt;AStarNode&gt;();</span><br><span class="line">		<span class="comment">//boundNodes.add(goalNode);</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>;y&lt;size.getY();++y)&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>;x&lt;size.getX();++x)&#123;</span><br><span class="line">				AStarNode node = <span class="keyword">new</span> AStarNode(<span class="keyword">new</span> Point(goalNode.location.x+x,goalNode.location.y+y));</span><br><span class="line">				<span class="keyword">for</span>(AStarNode neighbor : node.getNeighbors())&#123;</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span>(!boundNodes.contains(neighbor)&amp;&amp;!map.contains(neighbor.location.x, neighbor.location.y))</span><br><span class="line">						boundNodes.add(neighbor);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//System.out.println(boundNodes.size()+","+boundNodes);</span></span><br><span class="line">		<span class="keyword">return</span> boundNodes;</span><br><span class="line">		<span class="comment">//return findPath(map,startNode,boundNodes.getFirst());</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>  寻找路径 findPath</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinkedList&lt;Point&gt; <span class="title">findPath</span><span class="params">(GridMap map,AStarNode startNode,AStarNode goalNode)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		PriorityList openList = <span class="keyword">new</span> PriorityList();</span><br><span class="line">		LinkedList&lt;AStarNode&gt; closedList = <span class="keyword">new</span> LinkedList&lt;AStarNode&gt;();</span><br><span class="line">		 </span><br><span class="line">		startNode.costFromStart = <span class="number">0</span>;</span><br><span class="line">		startNode.estimatedCostToGoal = startNode.getEstimatedCost(goalNode);</span><br><span class="line">		startNode.pathParent = <span class="keyword">null</span>;</span><br><span class="line">		openList.add(startNode);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (!openList.isEmpty()) &#123;</span><br><span class="line">		</span><br><span class="line">			AStarNode node = (AStarNode) openList.removeFirst();</span><br><span class="line">			 </span><br><span class="line">			<span class="keyword">if</span> (node.equals(goalNode)) &#123;</span><br><span class="line">				<span class="keyword">return</span> constructPath(node);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			List neighbors = node.getNeighbors();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; neighbors.size(); i++) &#123;</span><br><span class="line">				</span><br><span class="line">				AStarNode neighborNode = (AStarNode) neighbors.get(i);</span><br><span class="line">				<span class="keyword">boolean</span> isOpen = openList.contains(neighborNode);</span><br><span class="line">				<span class="keyword">boolean</span> isClosed = closedList.contains(neighborNode);</span><br><span class="line">				<span class="keyword">float</span> costFromStart = node.costFromStart+ node.getCost(neighborNode);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// check if the neighbor node has not been</span></span><br><span class="line">				<span class="comment">// traversed or if a shorter path to this</span></span><br><span class="line">				<span class="comment">// neighbor node is found.</span></span><br><span class="line">				<span class="keyword">if</span> ( ( (!isOpen &amp;&amp; !isClosed)</span><br><span class="line">						|| costFromStart &lt; neighborNode.costFromStart)&amp;&amp;!neighborNode.isHit(map)) &#123;</span><br><span class="line">					</span><br><span class="line">					neighborNode.pathParent = node;</span><br><span class="line">					neighborNode.costFromStart = costFromStart;</span><br><span class="line">					neighborNode.estimatedCostToGoal = neighborNode</span><br><span class="line">							.getEstimatedCost(goalNode);</span><br><span class="line">					<span class="keyword">if</span> (isClosed) &#123;</span><br><span class="line">						closedList.remove(neighborNode);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> (!isOpen) &#123;</span><br><span class="line">						openList.add(neighborNode);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			closedList.add(node);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// no path found</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>  在一个不可访问的终点搜索出周围可以访问的节点findNode</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AStarNode <span class="title">findNode</span><span class="params">(GridMap map,AStarNode goalNode,AStarNode startNode)</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//open</span></span><br><span class="line">		PriorityList openList = <span class="keyword">new</span> PriorityList();</span><br><span class="line">		openList.add(goalNode);</span><br><span class="line">		<span class="comment">//closed</span></span><br><span class="line">		LinkedList&lt;AStarNode&gt; closedList = <span class="keyword">new</span> LinkedList&lt;AStarNode&gt;();</span><br><span class="line">		goalNode.costFromStart = <span class="number">0</span>;</span><br><span class="line">		goalNode.estimatedCostToGoal = goalNode.getEstimatedCost(startNode);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span>(!openList.isEmpty())&#123;</span><br><span class="line">			</span><br><span class="line">			AStarNode node = (AStarNode) openList.removeFirst();</span><br><span class="line">			<span class="keyword">if</span>(!map.contains(node.location.x, node.location.y))&#123;</span><br><span class="line">				<span class="keyword">return</span> node;</span><br><span class="line">			&#125;</span><br><span class="line"><span class="comment">//			if(!node.isHit(map))&#123;</span></span><br><span class="line"><span class="comment">//				return node;</span></span><br><span class="line"><span class="comment">//			&#125;</span></span><br><span class="line">			</span><br><span class="line">			List neighbors = node.getNeighbors();</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; neighbors.size(); i++) &#123;</span><br><span class="line">				</span><br><span class="line">				AStarNode neighbor = (AStarNode)node.getNeighbors().get(i);</span><br><span class="line">				<span class="keyword">boolean</span> isOpen = openList.contains(neighbor);</span><br><span class="line">				<span class="keyword">boolean</span> isClosed = closedList.contains(neighbor);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">float</span> costFromStart = node.costFromStart+ node.getCost(neighbor);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span> ( ( (!isOpen &amp;&amp; !isClosed)</span><br><span class="line">						|| costFromStart &lt; neighbor.costFromStart)) &#123;</span><br><span class="line">					</span><br><span class="line">					neighbor.costFromStart = costFromStart;</span><br><span class="line">					neighbor.estimatedCostToGoal = neighbor.getEstimatedCost(startNode);</span><br><span class="line">					<span class="comment">//加入到list中</span></span><br><span class="line">					openList.add(neighbor);</span><br><span class="line">					closedList.add(neighbor);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//System.out.println("cant'find:"+goalNode);</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h6 id="Tile类"><a href="#Tile类" class="headerlink" title="Tile类"></a>Tile类</h6><p>​    tile类中，所有类都实现了Tile接口，即可序列化接口，同时实现一批Tile单位都需要的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Tile</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">focus</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">blur</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Tile <span class="title">clone</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,GridMap gridMap)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Graphics2D g,<span class="keyword">int</span> offsetX,<span class="keyword">int</span> offsetY)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">long</span> elapsedTime)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTileX</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTileY</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Point <span class="title">getSize</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHealth</span><span class="params">(<span class="keyword">float</span> health)</span></span>;	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getHealth</span><span class="params">()</span></span>;	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">operate</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,String uuid )</span></span>;</span><br><span class="line">	 </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getDefence</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUUID</span><span class="params">(String i)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getUUID</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    实际上我们会线实现一个AbstractTile的抽象实现类，实现一些共同的方法或者存放一些共通的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractTile</span> <span class="keyword">implements</span> <span class="title">Tile</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> id;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">float</span> x, y;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> tileX,tileY;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">boolean</span> selected;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">float</span> health;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> GridMap gridMap;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> GridMapRender gm;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> String UUID;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AbstractTile</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Tile <span class="title">clone</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,GridMap gridMap)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Graphics2D g,<span class="keyword">int</span> offsetX,<span class="keyword">int</span> offsetY)</span></span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">long</span> elapsedTime)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTileX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> tileX;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTileY</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> tileY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSelected</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> 	selected;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">focus</span><span class="params">()</span></span>&#123;</span><br><span class="line">		selected = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">blur</span><span class="params">()</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		selected = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id/Constant.TYPE_SIZE;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHealth</span><span class="params">(<span class="keyword">float</span> health)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.health = health;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">operate</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,String uuid )</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getHealth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> health;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getUUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> UUID;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUUID</span><span class="params">(String uuid)</span> </span>&#123;</span><br><span class="line">		UUID = uuid;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    其中血量，坐标位置，小地图位置，UUID等等，是每一个Tile类都需要实现的。</p>
<p>其中的建筑物在建筑过程中又不同的变化，所以需要实现一个Builder接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readyBuild</span><span class="params">(BaseIcon icon)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isBuilding</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getComplete</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如果要将Tile中的单位做一个划分的话，应该分为如下的几种：</p>
<ul>
<li>可以移动的，没有建造过程的，例如 Scv这种，需要继承Sprite类。</li>
<li>不可以移动的，有建造过程的，例如Supply这种的，需要继承House类。</li>
<li>不可以移动，没有建造过程，例如Mine这种，直接继承AbstractTile类。</li>
</ul>
<hr>
<h6 id="paticles类"><a href="#paticles类" class="headerlink" title="paticles类"></a>paticles类</h6><p>​    在这个包中，定义了一个向量类Vector,和一个爆炸火花产生类，在单位收到攻击后，就会产生爆炸火花。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Graphics2D g, <span class="keyword">int</span> offsetX, <span class="keyword">int</span> offsetY)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; particles.size(); i++) &#123;</span><br><span class="line"></span><br><span class="line">			Particle part = (Particle) particles.get(i);</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(part.getLife()&gt;<span class="number">10</span>)&#123;</span><br><span class="line">				g.setColor(color);</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(part.getLife()&gt;<span class="number">5</span>)&#123;</span><br><span class="line">				g.setColor(Color.RED);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				g.setColor(color2);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			 </span><br><span class="line">			g.fill(<span class="keyword">new</span> Ellipse2D.Float(part.getPosition().getX() - offsetX,</span><br><span class="line">					part.getPosition().getY() - offsetY, Math.max(<span class="number">1</span>, <span class="number">1.5f</span></span><br><span class="line">							* part.getLife() / PARTICLES_MAX_LIFE), Math.max(<span class="number">1</span>,</span><br><span class="line">							<span class="number">1.5f</span> * part.getLife() / PARTICLES_MAX_LIFE)));</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(<span class="keyword">long</span> elapsedTime)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Particle part;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> count = particles.size();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line"></span><br><span class="line">			part = (Particle) particles.get(i);</span><br><span class="line"></span><br><span class="line">			part.update(elapsedTime);</span><br><span class="line">			<span class="keyword">if</span> (part.getLife() &gt; PARTICLES_MAX_LIFE) &#123;</span><br><span class="line">				particles.remove(i);</span><br><span class="line">				i--;</span><br><span class="line">				count = particles.size();</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (particles.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//			 for (int i = 0; i &lt; DEFAULT_NUM_PARTICLES; i++) &#123;</span></span><br><span class="line"><span class="comment">//			 particles.add(generateParticle());</span></span><br><span class="line"><span class="comment">//			 &#125;</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="net包"><a href="#net包" class="headerlink" title="net包"></a>net包</h5><p>​    net包内有关网络的包，主要分为如下的内容：</p>
<img src="/2020/07/12/StarCraft-Java/NET.png" class="">

<ul>
<li><p>datagram包内，主要是各种info信息，例如点击，移动等等信息，这些info都实现了Serializable接口，以便于序列化传输。</p>
</li>
<li><p>socket包内，主要是Client客户端，Listener，Server服务端等等。在一台电脑上，要么启动Client，要么启动Server。</p>
</li>
<li><p>udp包，主要用于扫描局域网络中有没有人建立了主机。</p>
</li>
<li><p>NetWorkManager：每个JStarWar应用程序对应一个NewWorkManager,每当一个用户创建Server的时候广播一次.通知所有在局域网的用户有这个Server.每个Client后台需要开一个线程不停的监听获取的信息. 另外,对于已在的服务器列表需要开个dectector线程不停的监听.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NetWorkManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">establishServer</span><span class="params">(String serverName)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(PlayerInfo clientInfo, PlayerInfo serverInfo)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeListen</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(String name, <span class="keyword">int</span> index)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> PlayerList <span class="title">startGame</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPlayerListener</span><span class="params">(PlayerListener playerListener)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addClientListener</span><span class="params">(ClientListener clientListener)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">(List&lt;Sprite&gt; sprites, <span class="keyword">int</span> tx, <span class="keyword">int</span> ty)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> tile</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> tx</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ty</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> newTileUUID 新tileUUID</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">(Tile tile, <span class="keyword">int</span> tx, <span class="keyword">int</span> ty,String newTileUUID)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(IconInfo iconInfo)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readyBuild</span><span class="params">(IconInfo iconInfo)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 为了避免数据不同步，需要通知每个Player删除tile</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> iconInfo</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(SpriteInfo spriteInfo)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h6 id="icon包"><a href="#icon包" class="headerlink" title="icon包"></a>icon包</h6><p>​    实现了类似于贴图的功能,每个实现类中,有点击,图片,获取一系列熟悉等等方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseIcon</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> Image iconImage;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> List&lt;IconBean&gt; tileImages = <span class="keyword">new</span> ArrayList&lt;IconBean&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> Resource resource;</span><br><span class="line">	</span><br><span class="line">	 </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BaseIcon</span><span class="params">(Image iconImage)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.iconImage = iconImage;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onClicked</span><span class="params">(GridMapRender gridMapRender)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Tile house,Image tileImage,Resource resource)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.tileImages.add(<span class="keyword">new</span> IconBean(house,tileImage));</span><br><span class="line">		<span class="keyword">this</span>.resource=resource;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Image <span class="title">getTileImage</span><span class="params">(<span class="keyword">int</span> type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> tileImages.get(type).image;</span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 返回一个原始Tile</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Tile <span class="title">getTile</span><span class="params">(<span class="keyword">int</span> type)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> tileImages.get(type).tile;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Resource <span class="title">getResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> resource;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Image <span class="title">getIconImage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> iconImage;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getBuildSpeed</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="number">0.0f</span>;&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IconBean</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> Image image;</span><br><span class="line">		<span class="keyword">public</span> Tile tile;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">IconBean</span><span class="params">(Tile tile,Image image)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">super</span>();</span><br><span class="line">			<span class="keyword">this</span>.image = image;</span><br><span class="line">			<span class="keyword">this</span>.tile = tile;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h6 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a>GUI</h6><p>​    ui继承了特定的类，AbstractPanel。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GamePanel</span> <span class="keyword">extends</span> <span class="title">Abstractpanel</span></span>&#123;</span><br><span class="line">  	</span><br><span class="line">  	</span><br><span class="line">  	GridMap gridmap;</span><br><span class="line">  </span><br><span class="line">  	GridMapRender gridMapRender;</span><br><span class="line">  	</span><br><span class="line">  	Control control;</span><br><span class="line">  </span><br><span class="line">  	ConsolePanel controlPanel;</span><br><span class="line">  	</span><br><span class="line">  	Robot robot; </span><br><span class="line">  	 </span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">  		</span><br><span class="line">  		initControl();</span><br><span class="line">  		gridmap = ResourceManager.resourceManager.getGridMap();</span><br><span class="line">  		gridMapRender = gridmap.getTileMapRender();</span><br><span class="line">  		gridMapRender.screenWidth = getWidth();</span><br><span class="line">  		gridMapRender.screenHeight = getHeight();</span><br><span class="line">  		controlPanel = <span class="keyword">new</span> ConsolePanel(gridMapRender);</span><br><span class="line">  		controlPanel.setLocation(getWidth() - controlPanel.getWidth(), <span class="number">0</span>);</span><br><span class="line">  		add(controlPanel);</span><br><span class="line">  		</span><br><span class="line">  		<span class="keyword">try</span> &#123;</span><br><span class="line">  			robot = <span class="keyword">new</span> Robot();</span><br><span class="line">  		&#125; <span class="keyword">catch</span> (AWTException e) &#123;</span><br><span class="line">  			e.printStackTrace();</span><br><span class="line">  		&#125;</span><br><span class="line">  		</span><br><span class="line">  		gridMapRender.addMsg(<span class="string">"温馨提示：按数字键1选中所有农民"</span>);</span><br><span class="line">  		gridMapRender.addMsg(<span class="string">"温馨提示：按数字键2选中所有机枪兵"</span>);</span><br><span class="line">  	&#125;</span><br><span class="line">  	</span><br><span class="line">  	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initControl</span><span class="params">()</span></span>&#123;</span><br><span class="line">  		</span><br><span class="line">  		GameGUI  gui = (GameGUI) <span class="keyword">this</span>.getParent();</span><br><span class="line">  		control = <span class="keyword">new</span> Control(<span class="keyword">this</span>,	gui.frame);</span><br><span class="line">  		</span><br><span class="line">  		control.addKeyPressListener(<span class="keyword">new</span> KeyPressListener()&#123;</span><br><span class="line">  </span><br><span class="line">  			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">press</span><span class="params">(<span class="keyword">int</span> keyCode)</span> </span>&#123;</span><br><span class="line">  				</span><br><span class="line">  				<span class="keyword">if</span>(keyCode==KeyEvent.VK_1)&#123;</span><br><span class="line">  					gridMapRender.blur();</span><br><span class="line">  					<span class="keyword">for</span>(Tile tile:gridmap.getTiles())&#123;</span><br><span class="line">  						</span><br><span class="line">  						<span class="keyword">boolean</span> isScv = (tile.getType()==gridMapRender.getCurrentType())</span><br><span class="line">  									&amp;&amp;(tile <span class="keyword">instanceof</span> Scv);</span><br><span class="line">  						<span class="keyword">if</span>(isScv)&#123;</span><br><span class="line">  							tile.focus();</span><br><span class="line">  							gridMapRender.addFocusSprite((Sprite)tile);</span><br><span class="line">  						&#125;</span><br><span class="line">  						</span><br><span class="line">  					&#125;</span><br><span class="line">  				&#125;</span><br><span class="line">  				<span class="keyword">else</span> <span class="keyword">if</span>(keyCode==KeyEvent.VK_2)&#123;</span><br><span class="line">  					gridMapRender.blur();</span><br><span class="line">  					<span class="keyword">for</span>(Tile tile:gridmap.getTiles())&#123;</span><br><span class="line">  						</span><br><span class="line">  						<span class="keyword">boolean</span> isMarine = tile.getType()==gridMapRender.getCurrentType()</span><br><span class="line">  									&amp;&amp;tile <span class="keyword">instanceof</span> Marine;</span><br><span class="line">  						<span class="keyword">if</span>(isMarine)&#123;</span><br><span class="line">  							tile.focus();</span><br><span class="line">  							gridMapRender.addFocusSprite((Sprite)tile);</span><br><span class="line">  						&#125;</span><br><span class="line">  						</span><br><span class="line">  					&#125;</span><br><span class="line">  				&#125;</span><br><span class="line">  			&#125;</span><br><span class="line">  			</span><br><span class="line">  		&#125;);</span><br><span class="line">  		control.addDragListener(<span class="keyword">new</span> DragListener()&#123;</span><br><span class="line">  			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drag</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy)</span> </span>&#123;</span><br><span class="line">  				gridMapRender.focus(x, y, dx, dy);</span><br><span class="line">  			&#125;</span><br><span class="line">  		&#125;);</span><br><span class="line">  		control.addLeftPressListener(<span class="keyword">new</span> LeftPressListener()&#123;</span><br><span class="line">  			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">press</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">  				<span class="comment">//gridMapRender.focus(x, y);</span></span><br><span class="line">  				gridMapRender.operate(x, y);</span><br><span class="line">  			&#125;</span><br><span class="line">  			</span><br><span class="line">  		&#125;);</span><br><span class="line">  		control.addRightPressListener(<span class="keyword">new</span> RightPressListener()&#123;</span><br><span class="line">  			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">press</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">  				gridMapRender.move(x, y);</span><br><span class="line">  			&#125;</span><br><span class="line">  		&#125;);	</span><br><span class="line">  		</span><br><span class="line">  		control.addMoveListener(<span class="keyword">new</span> MoveListener()&#123;</span><br><span class="line">  </span><br><span class="line">  			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">  				 </span><br><span class="line">  				<span class="keyword">int</span> offsetX = gridMapRender.offsetX;</span><br><span class="line">  				<span class="keyword">int</span> screenX = getWidth()-GridMapRender.TILE_WIDTH;</span><br><span class="line">  				 </span><br><span class="line">  				<span class="comment">//如果鼠标位于屏幕宽度前一个TILE宽度</span></span><br><span class="line">  				<span class="keyword">if</span>(x&gt;screenX&amp;&amp;offsetX&lt;GridMapRender.tileXToPx(<span class="number">107</span>))&#123;</span><br><span class="line">  					<span class="comment">//向右移动一个tile宽度</span></span><br><span class="line">  					gridMapRender.offsetX=offsetX+GridMapRender.TILE_WIDTH;</span><br><span class="line">  					robot.mouseMove(screenX, y);</span><br><span class="line">  					++controlPanel.map_panel.x;</span><br><span class="line">  				&#125;</span><br><span class="line">  				<span class="comment">//如果鼠标在一个TILE宽度</span></span><br><span class="line">  				<span class="keyword">if</span>(x&lt;GridMapRender.TILE_WIDTH&amp;&amp;offsetX&gt;<span class="number">0</span>)&#123;</span><br><span class="line">  					gridMapRender.offsetX=offsetX-GridMapRender.TILE_WIDTH;</span><br><span class="line">  					robot.mouseMove(GridMapRender.TILE_WIDTH, y);</span><br><span class="line">  					--controlPanel.map_panel.x;</span><br><span class="line">  				&#125;</span><br><span class="line">  				</span><br><span class="line">  				<span class="comment">//纵坐标和水平坐标逻辑相同</span></span><br><span class="line">  				<span class="keyword">int</span> offsetY = gridMapRender.offsetY;</span><br><span class="line">  				<span class="keyword">int</span> screenY = getHeight()-GridMapRender.TILE_HEIGHT;</span><br><span class="line">  				</span><br><span class="line">  				<span class="keyword">if</span>(y&gt;screenY&amp;&amp;offsetY&lt;GridMapRender.tileXToPx(<span class="number">110</span>))&#123;</span><br><span class="line">  					<span class="comment">//向右移动一个tile宽度</span></span><br><span class="line">  					gridMapRender.offsetY=offsetY+GridMapRender.TILE_HEIGHT;</span><br><span class="line">  					robot.mouseMove(x, screenY);</span><br><span class="line">  					++controlPanel.map_panel.y;</span><br><span class="line">  				&#125;</span><br><span class="line">  				</span><br><span class="line">  				<span class="keyword">if</span>(y&lt;GridMapRender.TILE_HEIGHT&amp;&amp;offsetY&gt;<span class="number">0</span>)&#123;</span><br><span class="line">  					gridMapRender.offsetY=offsetY-GridMapRender.TILE_WIDTH;</span><br><span class="line">  					robot.mouseMove(x, GridMapRender.TILE_HEIGHT);</span><br><span class="line">  					--controlPanel.map_panel.y;</span><br><span class="line">  				&#125;</span><br><span class="line">  				</span><br><span class="line">  				gridMapRender.moveX = x;</span><br><span class="line">  				gridMapRender.moveY = y;</span><br><span class="line">  				</span><br><span class="line">  			&#125;</span><br><span class="line">  			</span><br><span class="line">  		&#125;);</span><br><span class="line">  		</span><br><span class="line">  		</span><br><span class="line">  	&#125;</span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="title">GamePanel</span><span class="params">(GameGUI parent, String name)</span> </span>&#123;</span><br><span class="line">  		<span class="keyword">super</span>(parent, name);</span><br><span class="line">  	&#125;</span><br><span class="line">  	</span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">paintComponent</span><span class="params">(Graphics g)</span> </span>&#123;</span><br><span class="line">  		</span><br><span class="line">  		gridMapRender.draw((Graphics2D)g);</span><br><span class="line">  		<span class="comment">//画控制线</span></span><br><span class="line">  		control.drag(g);</span><br><span class="line">  		</span><br><span class="line">  	&#125;</span><br><span class="line">  	</span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">long</span> elapsedTime)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  		gridMapRender.update(elapsedTime);</span><br><span class="line">  		 </span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中update方法比较重要，用来重构整个页面。</p>
<hr>
<h6 id="core"><a href="#core" class="headerlink" title="core"></a>core</h6><p>core类中包含一系列基础操作的类，如Control，FocusManager,GridMapRender等等，其中GameCore是整个程序的入口类，继承了JFrame类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">GameCore</span> <span class="keyword">extends</span> <span class="title">JFrame</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FONT_SIZE = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isRunning;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> JFrame window;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Calls init() and gameLoop()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		init();</span><br><span class="line">		gameLoop();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Sets full screen mode and initiates and objects.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		setUndecorated(<span class="keyword">true</span>);</span><br><span class="line">		setTitle(<span class="string">"JStarCraft"</span>);</span><br><span class="line">		setIconImage(ResourceManager.loadImage(<span class="string">"title.png"</span>));</span><br><span class="line">		setDefaultCloseOperation(EXIT_ON_CLOSE);</span><br><span class="line">		setSize(<span class="number">1920</span>, <span class="number">1080</span>);</span><br><span class="line">		setVisible(<span class="keyword">true</span>);</span><br><span class="line">		setIgnoreRepaint(<span class="keyword">true</span>);</span><br><span class="line">		setResizable(<span class="keyword">false</span>);</span><br><span class="line">		setFont(<span class="keyword">new</span> Font(<span class="string">"Dialog"</span>, Font.PLAIN, FONT_SIZE));</span><br><span class="line">		setBackground(Color.black);</span><br><span class="line">		setForeground(Color.white);</span><br><span class="line">		createBufferStrategy(<span class="number">2</span>);</span><br><span class="line">		isRunning = <span class="keyword">true</span>;</span><br><span class="line">		setCursor(Toolkit.getDefaultToolkit().createCustomCursor(</span><br><span class="line">				ResourceManager.loadImage(<span class="string">"cur.png"</span>), <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>), <span class="string">"cur"</span>));</span><br><span class="line">		window = getWindow();</span><br><span class="line">		NullRepaintManager.install();</span><br><span class="line">		window.setLayout(<span class="keyword">null</span>);</span><br><span class="line">		Container contentPane = getWindow().getContentPane();</span><br><span class="line">		((JComponent) contentPane).setOpaque(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Runs through the game loop until stop() is called.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">gameLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		BufferStrategy strategy = getBufferStrategy();</span><br><span class="line">		<span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">		<span class="keyword">long</span> currTime = startTime;</span><br><span class="line">		<span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">long</span> elapsedTime = System.currentTimeMillis() - currTime;</span><br><span class="line">			currTime += elapsedTime;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// update</span></span><br><span class="line">			update(elapsedTime);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// draw the screen</span></span><br><span class="line">			Graphics2D g = (Graphics2D) strategy.getDrawGraphics();</span><br><span class="line">			g.setRenderingHint(RenderingHints.KEY_ANTIALIASING,</span><br><span class="line">					RenderingHints.VALUE_ANTIALIAS_ON);</span><br><span class="line">			g.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,</span><br><span class="line">					RenderingHints.VALUE_TEXT_ANTIALIAS_ON);		</span><br><span class="line">			<span class="comment">// g.drawImage(ResourceManager.loadImage("background3.jpg"), 0, 33,</span></span><br><span class="line">			<span class="comment">// null);</span></span><br><span class="line">			draw(g);</span><br><span class="line">			g.dispose();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!strategy.contentsLost()) &#123;</span><br><span class="line">				strategy.show();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// take a nap</span></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				Thread.sleep(<span class="number">5</span>);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Updates the state of the game/animation based on the amount of elapsed</span></span><br><span class="line"><span class="comment">	 * time that has passed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">long</span> elapsedTime)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// do nothing</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Draws to the screen. Subclasses must override this method.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Graphics2D g)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> JFrame <span class="title">getWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
</li>
</ul>
<h3 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h3><p>  一共有AWT线程和自定义的Repaint线程和main线程。</p>
<p>  在awt线程中监视鼠标方法等等，同时在repaint线程中重画这种内容。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/12/StarCraft-Java/" data-id="ckfwobq2s000b8srda4xy2nhi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaSE/" rel="tag">JavaSE</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-SQLClient学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/12/SQLClient%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2020-05-12T07:16:24.000Z" itemprop="datePublished">2020-05-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/12/SQLClient%E5%AD%A6%E4%B9%A0/">SQLClient学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p>SQLClient 位于Flink的Tablejar包内,通过调用tableAPI解析SQL，并将任务提交Flink集群。其中的好处在于无需编写复杂的Java或者Scala代码，通过SQL即可实现想要实现的功能，同时也可以做到无需生成Jar包即可提交任务，使得flink任务的配置和提交变得灵活多变，可以将其集成在别的应用中。</p>
<h4 id="SQLClient的使用"><a href="#SQLClient的使用" class="headerlink" title="SQLClient的使用"></a>SQLClient的使用</h4><blockquote>
<p>sqlclient.sh 位于 <strong>%flink%/bin</strong> 目录下 启动时候需要指定模式 <strong>embedded</strong> 或者 <strong>gateway</strong> 模式，在flink1.10中还不支持gateway模式。<br>使用embedded模式时候命令行命令为：    </p>
<figure class="highlight plain"><figcaption><span>embedded ```  </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">源码内对于 __embedded__ 模式和 __gateway__ 模式，在源码里有如下的说明：  </span><br><span class="line">&#123;% asset_img moshi.png %&#125;</span><br><span class="line"></span><br><span class="line">使用 __sqlclient__ 时候，需要指定参数，官方建议调试时候指定  </span><br><span class="line">&#96;&#96;&#96; embedded --defaults &#x2F;path&#x2F;to&#x2F;sql-client-defaults.yaml --jar &#x2F;path&#x2F;to&#x2F;target&#x2F;flink-sql-client-*.jar </span><br></pre></td></tr></table></figure>
<p>输入命令: <code>./sqlclient.sh embedded --defaults /path/to/sql-client-defaults.yaml --jar /path/to/target/flink-sql-client-*.jar</code><br>如果一切正常，可以看到如下界面：  </p>
<img src="/2020/05/12/SQLClient%E5%AD%A6%E4%B9%A0/sqlclientview.png" class="">
<p>接下来就可以正常编写SQL了！</p>
</blockquote>
<h4 id="SQLClient的原理"><a href="#SQLClient的原理" class="headerlink" title="SQLClient的原理"></a>SQLClient的原理</h4><blockquote>
<p>在输入 <code>./sqlclient.sh</code> 后,其实调用的是 org.apache.flink.table.client包中的Sqlclient类中的main方法<br>main 方法内首先对于参数中的jar -j和lib -l 参数进行扫描，拿到Jar包和lib目录后，传给LocalExecutor后，启动localExecutor方法()  </p>
<figure class="highlight plain"><figcaption><span>Executor executor </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LocalExecutor类是个什么东西呢？</span><br><span class="line">&gt;&gt;&#96;&#96;&#96; </span><br><span class="line">   &#x2F;&#x2F; deployment</span><br><span class="line"></span><br><span class="line">private final ClusterClientServiceLoader clusterClientServiceLoader;</span><br><span class="line">private final Environment defaultEnvironment;</span><br><span class="line">private final List&lt;URL&gt; dependencies;</span><br><span class="line">private final Configuration flinkConfig;</span><br><span class="line">private final List&lt;CustomCommandLine&gt; commandLines;</span><br><span class="line">private final Options commandLineOptions;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; result maintenance</span><br><span class="line"></span><br><span class="line">private final ResultStore resultStore; </span><br></pre></td></tr></table></figure>
<blockquote>
<p>其中localexecutor 中持有的一些对象</p>
</blockquote>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/12/SQLClient%E5%AD%A6%E4%B9%A0/" data-id="ckfwobq2p00088srdenw42odb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flink-table-api/" rel="tag">flink,table-api</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Graph学习" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/07/Graph%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time datetime="2020-04-07T11:45:59.000Z" itemprop="datePublished">2020-04-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/07/Graph%E5%AD%A6%E4%B9%A0/">Graph学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p>Flink的Graph分为4层：<br>&nbsp;&nbsp;&nbsp;&nbsp;为：StreamGraph-&gt;JobGraph-&gt;ExecutionGraph-&gt;物理执行图</p>
<ul>
<li>StreamGraph:是根据用户通过 Stream API 编写的代码生成的最初的图。用来表示程序的拓扑结构。</li>
</ul>
<ul>
<li><p>JobGraph：StreamGraph经过优化后生成了 JobGraph，提交给 JobManager 的数据结构。主要的优化为，将多个符合条件的节点 chain 在一起作为一个节点，这样可以减少数据在节点之间流动所需要的序列化/反序列化/传输消耗。</p>
</li>
<li><p>ExecutionGraph：JobManager 根据 JobGraph 生成ExecutionGraph。ExecutionGraph是JobGraph的并行化版本，是调度层最核心的数据结构。</p>
</li>
<li><p>物理执行图：JobManager 根据 ExecutionGraph 对 Job 进行调度后，在各个TaskManager 上部署 Task 后形成的“图”，并不是一个具体的数据结构。</p>
</li>
</ul>
<img src="/2020/04/07/Graph%E5%AD%A6%E4%B9%A0/%E6%89%A7%E8%A1%8C%E5%9B%BE.png" class="">




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/07/Graph%E5%AD%A6%E4%B9%A0/" data-id="ckfwobq2j00038srd5e9pfn19" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flink/" rel="tag">Flink</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-初次使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/07/%E5%88%9D%E6%AC%A1%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2020-04-07T10:32:45.553Z" itemprop="datePublished">2020-04-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/07/%E5%88%9D%E6%AC%A1%E4%BD%BF%E7%94%A8/">初次使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&nbsp;&nbsp;&nbsp;&nbsp;今天下午捣鼓了一下，终于用hexo搭建起来自己的blog。有一点点小激动，以后常常使用，多多总结。</p>
<hr>
<p>&nbsp;&nbsp;&nbsp;&nbsp;个人很喜欢的一句话，来自贴吧的一位老哥，但是已经忘掉了后半句，只记得前半句:”灵台清明者…”，希望以后可以做一个这样的人，顺便将后半句话补全。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/07/%E5%88%9D%E6%AC%A1%E4%BD%BF%E7%94%A8/" data-id="ckfwobq2q00098srd532haasu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-HTTP/" rel="tag">C HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/" rel="tag">Flink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaSE/" rel="tag">JavaSE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink/" rel="tag">flink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flink-table-api/" rel="tag">flink,table-api</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C-HTTP/" style="font-size: 10px;">C HTTP</a> <a href="/tags/Flink/" style="font-size: 10px;">Flink</a> <a href="/tags/JavaSE/" style="font-size: 10px;">JavaSE</a> <a href="/tags/flink/" style="font-size: 10px;">flink</a> <a href="/tags/flink-table-api/" style="font-size: 10px;">flink,table-api</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/05/LearnTinyHttp/">国庆假期特别篇-TinyHttp</a>
          </li>
        
          <li>
            <a href="/2020/08/05/sqlclient2/">sqlclient2</a>
          </li>
        
          <li>
            <a href="/2020/07/12/StarCraft-Java/">StarCraft_Java</a>
          </li>
        
          <li>
            <a href="/2020/05/12/SQLClient%E5%AD%A6%E4%B9%A0/">SQLClient学习</a>
          </li>
        
          <li>
            <a href="/2020/04/07/Graph%E5%AD%A6%E4%B9%A0/">Graph学习</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 hyx<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>